{"version":3,"sources":["../../../src/updateDB/updateUser/updatePlayerStatusAfterOrder.js"],"names":["updatePlayerStatusAfterOrder","playerId","findOne","_id","Types","ObjectId","populate","path","select","player","find","playerOpenBets","$gte","startOf","$lte","endOf","playerHistoryBets","playerCreditPending","reduce","total","openBet","wagerDetail","riskAmount","playerCurrentBalance","historyBet","resultAmount","straightBetCounter","orderType","parlayBetCounter","teaserBetCounter","reverseBetCounter","totalRisk","Number","totalWin","winAmount","playerCurrentStatus","creditPending","currentBalance","availableCredit","defaultSetting","weeklyStartCredit","playerOpenBetStatus","straightBet","parlayBet","teaserBet","reverseBet","totalBets","length","findOneAndUpdate","currentStatus","openBetStatus","new","then","console","log","result","agent"],"mappings":"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","file":"updatePlayerStatusAfterOrder.js","sourcesContent":["import Player from '../../models/Player';\nimport { OpenBet, HistoryBet } from '../../models/BetOrder';\nimport moment from 'moment'\nimport mongoose from 'mongoose'\n// update player current status every time order changed\nconst updatePlayerStatusAfterOrder = async (playerId) => {\n\n\ttry {\n\t\tconst player = await Player.findOne({ _id: mongoose.Types.ObjectId(playerId) }, 'defaultSetting.weeklyStartCredit agent').populate({ path: 'agent', select: 'account.username' })\n\n\t\tconst playerOpenBets = await OpenBet.find({ 'owner.player': mongoose.Types.ObjectId(playerId) }, 'orderType wagerDetail.riskAmount wagerDetail.winAmount')\n\t\tconst playerHistoryBets = await HistoryBet.find({ 'owner.player': mongoose.Types.ObjectId(playerId), 'closedAt': {$gte: moment().startOf('isoWeek'), $lte: moment().endOf('isoWeek')} }, 'closedAt resultAmount')\n\t\tconst playerCreditPending = playerOpenBets.reduce((total, openBet) => total + openBet.wagerDetail.riskAmount, 0)\n\t\tconst playerCurrentBalance = playerHistoryBets.reduce((total, historyBet) => total + historyBet.resultAmount ,0)\n\n\t\tconst straightBetCounter = playerOpenBets.reduce((total, openBet) => total + ( openBet.orderType === 'Straight' ), 0)\n\t\tconst parlayBetCounter = playerOpenBets.reduce((total, openBet) => total + ( openBet.orderType === 'Parlay' ), 0)\n\t\tconst teaserBetCounter = playerOpenBets.reduce((total, openBet) => total + ( openBet.orderType === 'Teaser6040' || openBet.orderType === 'Teaser6545' || openBet.orderType === 'Teaser7050' || openBet.orderType === 'SuperTeaser' ), 0)\n\t\tconst reverseBetCounter = playerOpenBets.reduce((total, openBet) => total + ( openBet.orderType === 'ActionReverse' || openBet.orderType === 'WinReverse' ), 0)\n\t\tconst totalRisk = playerOpenBets.reduce((total, openBet) => total + Number(openBet.wagerDetail.riskAmount), 0)\n\t\tconst totalWin = playerOpenBets.reduce((total, openBet) => total + Number(openBet.wagerDetail.winAmount), 0)\n\n\t\tconst playerCurrentStatus = {\n\t\t\tcreditPending: playerCreditPending,\n\t\t\tcurrentBalance: playerCurrentBalance,\n\t\t\tavailableCredit: Number(player.defaultSetting.weeklyStartCredit) - Number(playerCreditPending) + Number(playerCurrentBalance)\n\t\t}\n\t\t\n\t\tconst playerOpenBetStatus = {\n\t\t\tstraightBet: straightBetCounter || 0,\n\t\t\tparlayBet: parlayBetCounter || 0,\n\t\t\tteaserBet: teaserBetCounter || 0,\n\t\t\treverseBet: reverseBetCounter || 0,\n\t\t\ttotalBets: playerOpenBets.length || 0,\n\t\t\ttotalRisk: totalRisk || 0,\n\t\t\ttotalWin: totalWin || 0\n\t\t}\n\n\t\tawait Player.findOneAndUpdate({ _id: mongoose.Types.ObjectId(playerId) }, {'$set': { currentStatus: playerCurrentStatus, openBetStatus: playerOpenBetStatus }}, {new: true}).then(result => {\n\t\t\tconsole.log(result)\n\t\t})\n\t\t\n\t\treturn player.agent._id\n\t\t// return player.agent\n\n\t}catch(err){\n\t\tthrow err\n\t}\n}\n\nexport default updatePlayerStatusAfterOrder\n\n\n\n\n\n// const playerOpenBets = await OpenBet.find({ 'owner.player': req.user._id }, 'orderType wagerDetail.riskAmount wagerDetail.winAmount')\n// const playerHistoryBets = await HistoryBet.find({ 'owner.player': req.user._id, 'closedAt': {$gte: moment().startOf('isoWeek'), $lte: moment().endOf('isoWeek')} }, 'closedAt resultAmount')\n// const playerCreditPending = playerOpenBets.reduce((total, openBet) => total + openBet.wagerDetail.riskAmount, 0)\n// const playerCurrentBalance = playerHistoryBets.reduce((total, historyBet) => total + historyBet.resultAmount ,0)\n\n// const playerCurrentStatus = {\n// \tcreditPending: playerCreditPending,\n// \tcurrentBalance: playerCurrentBalance,\n// \tavailableCredit: Number(req.user.defaultSetting.weeklyStartCredit) - Number(playerCreditPending) + Number(playerCurrentBalance)\n// }\n// await Player.findOneAndUpdate({ _id: req.user._id }, {'$set': { currentStatus: playerCurrentStatus }})\n\n// // const totalWin = playerOpenBets.reduce((total, openBet) => total + Number(openBet.wagerDetail.winAmount), 0)\n// // const totalRisk = playerOpenBets.reduce((total, openBet) => total + Number(openBet.wagerDetail.riskAmount), 0)\n// // const straightBetCounter = playerOpenBets.reduce((total, openBet) => total + ( openBet.orderType === 'Straight' ), 0)\n// // const parlayBetCounter = playerOpenBets.reduce((total, openBet) => total + ( openBet.orderType === 'Parlay' ), 0)\n// // const teaserBetCounter = playerOpenBets.reduce((total, openBet) => total + ( openBet.orderType === 'Teaser6040' || openBet.orderType === 'Teaser6545' || openBet.orderType === 'Teaser7050' || openBet.orderType === 'SuperTeaser' ), 0)  // indexOf\n// // const reverseBetCounter = playerOpenBets.reduce((total, openBet) => total + ( openBet.orderType === 'ActionReverse' || openBet.orderType === 'WinReverse' ), 0)\n\n// const playerAccount = {\n// \topenBetStatus: {\n// \t\tstraightBet: straightBetCounter || 0,\n// \t\tparlayBet: parlayBetCounter || 0,\n// \t\tteaserBet: teaserBetCounter || 0,\n// \t\treverseBet: reverseBetCounter || 0,\n// \t\ttotalBets: playerOpenBets.length || 0,\n// \t\ttotalRisk: totalRisk || 0,\n// \t\ttotalWin: totalWin || 0\n// \t},\n// \tthisWeekHistoryBetList: playerHistoryBets\n// }\n"]}