{"version":3,"sources":["../../../../src/updateDB/confirmOrderTypeResult/utils/saveNewHistoryBet.js"],"names":["saveNewHistoryBet","openBet","betOrderStatus","resultAmount","newHistoryBet","orderNumber","orderType","owner","wagerDetail","status","eventOdds","createdAt","closedAt","save","console","log","findOneAndRemove","_id","findOneAndUpdate","agent","newAgentTransaction","player","superAgent","transactionType","creditAmount","currentStatus","credit"],"mappings":";;;;;;AAAA;;AACA;;;;AAEA;;;;AACA;;;;;;;;AAGA,IAAMA;AAAA,sDAAoB,iBAAOC,OAAP,EAAgBC,cAAhB,EAAgCC,YAAhC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGlBC,mBAHkB,GAGF,yBAAe;AACpCC,oBAAaJ,QAAQI,WADe;AAEpCC,kBAAWL,QAAQK,SAFiB;AAGpCC,cAAON,QAAQM,KAHqB;AAIpCC,oBAAaP,QAAQO,WAJe;AAKpCC,eAAQP,cAL4B;AAMpCC,qBAAcA,YANsB;AAOpCO,kBAAWT,QAAQS,SAPiB;AAQpCC,kBAAWV,QAAQU,SARiB;AASpCC,iBAAU;AAT0B,OAAf,CAHE;AAAA;AAAA,aAelBR,cAAcS,IAAd,EAfkB;;AAAA;AAgBxBC,cAAQC,GAAR,CAAY,+BAA+BX,cAAcC,WAAzD;AAhBwB;AAAA,aAiBlB,kBAAQW,gBAAR,CAAyB,EAAEC,KAAKhB,QAAQgB,GAAf,EAAzB,CAjBkB;;AAAA;AAkBxBH,cAAQC,GAAR,CAAY,qBAAqBd,QAAQI,WAAzC;;AAlBwB,YAqBrBH,mBAAmB,MArBE;AAAA;AAAA;AAAA;;AAAA;AAAA,aAsBH,gBAAMgB,gBAAN,CAAuB,EAAED,KAAKhB,QAAQM,KAAR,CAAcY,KAArB,EAAvB,EAAqD,EAAE,QAAQ,EAAE,wBAAwBhB,YAA1B,EAAwC,iCAAiCA,YAAzE,EAAV,EAArD,CAtBG;;AAAA;AAsBjBgB,WAtBiB;;AAuBvBL,cAAQC,GAAR,CAAY,+CAAZ;AACIK,yBAxBmB,GAwBG,+BAAqB;AAC9Cb,cAAM;AACLc,gBAAQpB,QAAQM,KAAR,CAAcc,MADjB;AAELC,oBAAarB,QAAQM,KAAR,CAAce,UAFtB;AAGLH,eAAQlB,QAAQM,KAAR,CAAcY;AAHjB,QADwC;AAM9Cb,kBAAWL,QAAQK,SAN2B;AAO9CiB,wBAAiB,KAP6B;AAQ9CC,qBAAcrB,YARgC;AAS9CA,qBAAcgB,MAAMM,aAAN,CAAoBC,MAApB,GAA6BvB,YATG;AAU9CE,oBAAaJ,QAAQI,WAVyB;AAW9CM,kBAAW;AAXmC,OAArB,CAxBH;AAAA;AAAA,aAqCjBS,oBAAoBP,IAApB,EArCiB;;AAAA;AAsCvBC,cAAQC,GAAR,CAAY,6BAAZ;;AAtCuB;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAApB;;AAAA;AAAA;AAAA;AAAA,GAAN;;kBA+Cef,iB","file":"saveNewHistoryBet.js","sourcesContent":["import { OpenBet, HistoryBet } from '../../../models/BetOrder';\nimport moment from 'moment'\n\nimport Agent from '../../../models/Agent';\nimport AgentTransaction from '../../../models/AgentTransaction';\n\n\nconst saveNewHistoryBet = async (openBet, betOrderStatus, resultAmount) => {\n\n\ttry{\n\t\tconst newHistoryBet = new HistoryBet({\n\t\t\torderNumber: openBet.orderNumber,\n\t\t\torderType: openBet.orderType,\n\t\t\towner: openBet.owner,\n\t\t\twagerDetail: openBet.wagerDetail,\n\t\t\tstatus: betOrderStatus,\n\t\t\tresultAmount: resultAmount,\n\t\t\teventOdds: openBet.eventOdds,\n\t\t\tcreatedAt: openBet.createdAt,\n\t\t\tclosedAt: moment()\n\t\t})\n\t\t\n\t\tawait newHistoryBet.save()\n\t\tconsole.log('saved history straight bet' + newHistoryBet.orderNumber)\n\t\tawait OpenBet.findOneAndRemove({ _id: openBet._id })\n\t\tconsole.log('deleted openbet ' + openBet.orderNumber)\n\n\n\t\tif(betOrderStatus === 'Lost'){\n\t\t\tconst agent = await Agent.findOneAndUpdate({ _id: openBet.owner.agent }, { '$inc': { 'currentStatus.credit': resultAmount, 'currentStatus.availableCredit': resultAmount } })\n\t\t\tconsole.log('player lost game, updated agent status credit')\n\t\t\tlet newAgentTransaction = new AgentTransaction({\n\t\t\t\towner:{\n\t\t\t\t\tplayer: openBet.owner.player,\n\t\t\t\t\tsuperAgent : openBet.owner.superAgent,\n\t\t\t\t\tagent : openBet.owner.agent\n\t\t\t\t},\n\t\t\t\torderType: openBet.orderType,\n\t\t\t\ttransactionType: 'out',\n\t\t\t\tcreditAmount: resultAmount,\n\t\t\t\tresultAmount: agent.currentStatus.credit + resultAmount,\n\t\t\t\torderNumber: openBet.orderNumber,\n\t\t\t\tcreatedAt: moment()\n\t\t\t})\n\t\t\tawait newAgentTransaction.save()\n\t\t\tconsole.log('saved new agent transaction')\n\t\t}\n\n\t}catch(err){\n\t\tthrow err\n\t}\n\n}\n\nexport default saveNewHistoryBet"]}