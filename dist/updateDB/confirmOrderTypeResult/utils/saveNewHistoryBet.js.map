{"version":3,"sources":["../../../../src/updateDB/confirmOrderTypeResult/utils/saveNewHistoryBet.js"],"names":["saveNewHistoryBet","openBet","betOrderStatus","resultAmount","findOne","orderNumber","existedHistory","isEmpty","newHistoryBet","orderType","owner","wagerDetail","status","eventOdds","createdAt","closedAt","save","console","log","findOneAndRemove","_id","findOneAndUpdate","agent","newAgentTransaction","player","superAgent","transactionType","creditAmount","currentStatus","credit"],"mappings":";;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAGA,IAAMA;AAAA,sDAAoB,iBAAOC,OAAP,EAAgBC,cAAhB,EAAgCC,YAAhC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,aAIK,qBAAWC,OAAX,CAAmB,EAAEC,aAAaJ,QAAQI,WAAvB,EAAnB,CAJL;;AAAA;AAIlBC,oBAJkB;;AAAA,WAKrB,iBAAEC,OAAF,CAAUD,cAAV,CALqB;AAAA;AAAA;AAAA;;AAOjBE,mBAPiB,GAOD,yBAAe;AACpCH,oBAAaJ,QAAQI,WADe;AAEpCI,kBAAWR,QAAQQ,SAFiB;AAGpCC,cAAOT,QAAQS,KAHqB;AAIpCC,oBAAaV,QAAQU,WAJe;AAKpCC,eAAQV,cAL4B;AAMpCC,qBAAcA,YANsB;AAOpCU,kBAAWZ,QAAQY,SAPiB;AAQpCC,kBAAWb,QAAQa,SARiB;AASpCC,iBAAU;AAT0B,OAAf,CAPC;AAAA;AAAA,aAmBjBP,cAAcQ,IAAd,EAnBiB;;AAAA;AAoBvBC,cAAQC,GAAR,CAAY,+BAA+BV,cAAcH,WAAzD;AApBuB;AAAA,aAqBjB,kBAAQc,gBAAR,CAAyB,EAAEC,KAAKnB,QAAQmB,GAAf,EAAzB,CArBiB;;AAAA;AAsBvBH,cAAQC,GAAR,CAAY,qBAAqBjB,QAAQI,WAAzC;;AAtBuB,YAwBpBH,mBAAmB,MAxBC;AAAA;AAAA;AAAA;;AAAA;AAAA,aAyBF,gBAAMmB,gBAAN,CAAuB,EAAED,KAAKnB,QAAQS,KAAR,CAAcY,KAArB,EAAvB,EAAqD,EAAE,QAAQ,EAAE,wBAAwBnB,YAA1B,EAAwC,iCAAiCA,YAAzE,EAAV,EAArD,CAzBE;;AAAA;AAyBhBmB,WAzBgB;;AA0BtBL,cAAQC,GAAR,CAAY,+CAAZ;AACIK,yBA3BkB,GA2BI,+BAAqB;AAC9Cb,cAAM;AACLc,gBAAQvB,QAAQS,KAAR,CAAcc,MADjB;AAELC,oBAAaxB,QAAQS,KAAR,CAAce,UAFtB;AAGLH,eAAQrB,QAAQS,KAAR,CAAcY;AAHjB,QADwC;AAM9Cb,kBAAWR,QAAQQ,SAN2B;AAO9CiB,wBAAiB,KAP6B;AAQ9CC,qBAAcxB,YARgC;AAS9CA,qBAAcmB,MAAMM,aAAN,CAAoBC,MAApB,GAA6B1B,YATG;AAU9CE,oBAAaJ,QAAQI,WAVyB;AAW9CS,kBAAW;AAXmC,OAArB,CA3BJ;AAAA;AAAA,aAwChBS,oBAAoBP,IAApB,EAxCgB;;AAAA;AAyCtBC,cAAQC,GAAR,CAAY,6BAAZ;;AAzCsB;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAApB;;AAAA;AAAA;AAAA;AAAA,GAAN;;kBAmDelB,iB","file":"saveNewHistoryBet.js","sourcesContent":["import { OpenBet, HistoryBet } from '../../../models/BetOrder';\nimport moment from 'moment'\nimport _ from 'lodash'\nimport Agent from '../../../models/Agent';\nimport AgentTransaction from '../../../models/AgentTransaction';\n\n\nconst saveNewHistoryBet = async (openBet, betOrderStatus, resultAmount) => {\n\n\ttry{\n\t\t\n\t\tconst existedHistory = await HistoryBet.findOne({ orderNumber: openBet.orderNumber })\n\t\tif(_.isEmpty(existedHistory)){\n\n\t\t\tconst newHistoryBet = new HistoryBet({\n\t\t\t\torderNumber: openBet.orderNumber,\n\t\t\t\torderType: openBet.orderType,\n\t\t\t\towner: openBet.owner,\n\t\t\t\twagerDetail: openBet.wagerDetail,\n\t\t\t\tstatus: betOrderStatus,\n\t\t\t\tresultAmount: resultAmount,\n\t\t\t\teventOdds: openBet.eventOdds,\n\t\t\t\tcreatedAt: openBet.createdAt,\n\t\t\t\tclosedAt: moment()\n\t\t\t})\n\n\t\t\tawait newHistoryBet.save()\n\t\t\tconsole.log('saved history straight bet' + newHistoryBet.orderNumber)\n\t\t\tawait OpenBet.findOneAndRemove({ _id: openBet._id })\n\t\t\tconsole.log('deleted openbet ' + openBet.orderNumber)\n\n\t\t\tif(betOrderStatus === 'Lost'){\n\t\t\t\tconst agent = await Agent.findOneAndUpdate({ _id: openBet.owner.agent }, { '$inc': { 'currentStatus.credit': resultAmount, 'currentStatus.availableCredit': resultAmount } })\n\t\t\t\tconsole.log('player lost game, updated agent status credit')\n\t\t\t\tlet newAgentTransaction = new AgentTransaction({\n\t\t\t\t\towner:{\n\t\t\t\t\t\tplayer: openBet.owner.player,\n\t\t\t\t\t\tsuperAgent : openBet.owner.superAgent,\n\t\t\t\t\t\tagent : openBet.owner.agent\n\t\t\t\t\t},\n\t\t\t\t\torderType: openBet.orderType,\n\t\t\t\t\ttransactionType: 'out',\n\t\t\t\t\tcreditAmount: resultAmount,\n\t\t\t\t\tresultAmount: agent.currentStatus.credit + resultAmount,\n\t\t\t\t\torderNumber: openBet.orderNumber,\n\t\t\t\t\tcreatedAt: moment()\n\t\t\t\t})\n\t\t\t\tawait newAgentTransaction.save()\n\t\t\t\tconsole.log('saved new agent transaction')\n\t\t\t}\n\t\t}\n\n\t}catch(err){\n\t\tthrow err\n\t}\n\n}\n\nexport default saveNewHistoryBet"]}