{"version":3,"sources":["../../../../src/updateDB/confirmOrderTypeResult/utils/saveNewHistoryBet.js"],"names":["saveNewHistoryBet","openBet","betOrderStatus","resultAmount","newHistoryBet","orderNumber","orderType","owner","wagerDetail","status","eventOdds","createdAt","closedAt","findOne","existedHistory","isEmpty","save","console","log","findOneAndRemove","_id","findOneAndUpdate","agent","newAgentTransaction","player","superAgent","transactionType","creditAmount","currentStatus","credit"],"mappings":";;;;;;AAAA;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;;;AAGA,IAAMA;AAAA,sDAAoB,iBAAOC,OAAP,EAAgBC,cAAhB,EAAgCC,YAAhC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGlBC,mBAHkB,GAGF,yBAAe;AACpCC,oBAAaJ,QAAQI,WADe;AAEpCC,kBAAWL,QAAQK,SAFiB;AAGpCC,cAAON,QAAQM,KAHqB;AAIpCC,oBAAaP,QAAQO,WAJe;AAKpCC,eAAQP,cAL4B;AAMpCC,qBAAcA,YANsB;AAOpCO,kBAAWT,QAAQS,SAPiB;AAQpCC,kBAAWV,QAAQU,SARiB;AASpCC,iBAAU;AAT0B,OAAf,CAHE;AAAA;AAAA,aAeK,qBAAWC,OAAX,CAAmB,EAAER,aAAaJ,QAAQI,WAAvB,EAAnB,CAfL;;AAAA;AAelBS,oBAfkB;;AAAA,WAgBrB,iBAAEC,OAAF,CAAUD,cAAV,CAhBqB;AAAA;AAAA;AAAA;;AAAA;AAAA,aAiBjBV,cAAcY,IAAd,EAjBiB;;AAAA;AAkBvBC,cAAQC,GAAR,CAAY,+BAA+Bd,cAAcC,WAAzD;AAlBuB;AAAA,aAmBjB,kBAAQc,gBAAR,CAAyB,EAAEC,KAAKnB,QAAQmB,GAAf,EAAzB,CAnBiB;;AAAA;AAoBvBH,cAAQC,GAAR,CAAY,qBAAqBjB,QAAQI,WAAzC;;AApBuB,YAsBpBH,mBAAmB,MAtBC;AAAA;AAAA;AAAA;;AAAA;AAAA,aAuBF,gBAAMmB,gBAAN,CAAuB,EAAED,KAAKnB,QAAQM,KAAR,CAAce,KAArB,EAAvB,EAAqD,EAAE,QAAQ,EAAE,wBAAwBnB,YAA1B,EAAwC,iCAAiCA,YAAzE,EAAV,EAArD,CAvBE;;AAAA;AAuBhBmB,WAvBgB;;AAwBtBL,cAAQC,GAAR,CAAY,+CAAZ;AACIK,yBAzBkB,GAyBI,+BAAqB;AAC9ChB,cAAM;AACLiB,gBAAQvB,QAAQM,KAAR,CAAciB,MADjB;AAELC,oBAAaxB,QAAQM,KAAR,CAAckB,UAFtB;AAGLH,eAAQrB,QAAQM,KAAR,CAAce;AAHjB,QADwC;AAM9ChB,kBAAWL,QAAQK,SAN2B;AAO9CoB,wBAAiB,KAP6B;AAQ9CC,qBAAcxB,YARgC;AAS9CA,qBAAcmB,MAAMM,aAAN,CAAoBC,MAApB,GAA6B1B,YATG;AAU9CE,oBAAaJ,QAAQI,WAVyB;AAW9CM,kBAAW;AAXmC,OAArB,CAzBJ;AAAA;AAAA,aAsChBY,oBAAoBP,IAApB,EAtCgB;;AAAA;AAuCtBC,cAAQC,GAAR,CAAY,6BAAZ;;AAvCsB;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAApB;;AAAA;AAAA;AAAA;AAAA,GAAN;;kBAiDelB,iB","file":"saveNewHistoryBet.js","sourcesContent":["import { OpenBet, HistoryBet } from '../../../models/BetOrder';\nimport moment from 'moment'\nimport _ from 'lodash'\nimport Agent from '../../../models/Agent';\nimport AgentTransaction from '../../../models/AgentTransaction';\n\n\nconst saveNewHistoryBet = async (openBet, betOrderStatus, resultAmount) => {\n\n\ttry{\n\t\tconst newHistoryBet = new HistoryBet({\n\t\t\torderNumber: openBet.orderNumber,\n\t\t\torderType: openBet.orderType,\n\t\t\towner: openBet.owner,\n\t\t\twagerDetail: openBet.wagerDetail,\n\t\t\tstatus: betOrderStatus,\n\t\t\tresultAmount: resultAmount,\n\t\t\teventOdds: openBet.eventOdds,\n\t\t\tcreatedAt: openBet.createdAt,\n\t\t\tclosedAt: moment()\n\t\t})\n\t\t\n\t\tconst existedHistory = await HistoryBet.findOne({ orderNumber: openBet.orderNumber })\n\t\tif(_.isEmpty(existedHistory)){\n\t\t\tawait newHistoryBet.save()\n\t\t\tconsole.log('saved history straight bet' + newHistoryBet.orderNumber)\n\t\t\tawait OpenBet.findOneAndRemove({ _id: openBet._id })\n\t\t\tconsole.log('deleted openbet ' + openBet.orderNumber)\n\n\t\t\tif(betOrderStatus === 'Lost'){\n\t\t\t\tconst agent = await Agent.findOneAndUpdate({ _id: openBet.owner.agent }, { '$inc': { 'currentStatus.credit': resultAmount, 'currentStatus.availableCredit': resultAmount } })\n\t\t\t\tconsole.log('player lost game, updated agent status credit')\n\t\t\t\tlet newAgentTransaction = new AgentTransaction({\n\t\t\t\t\towner:{\n\t\t\t\t\t\tplayer: openBet.owner.player,\n\t\t\t\t\t\tsuperAgent : openBet.owner.superAgent,\n\t\t\t\t\t\tagent : openBet.owner.agent\n\t\t\t\t\t},\n\t\t\t\t\torderType: openBet.orderType,\n\t\t\t\t\ttransactionType: 'out',\n\t\t\t\t\tcreditAmount: resultAmount,\n\t\t\t\t\tresultAmount: agent.currentStatus.credit + resultAmount,\n\t\t\t\t\torderNumber: openBet.orderNumber,\n\t\t\t\t\tcreatedAt: moment()\n\t\t\t\t})\n\t\t\t\tawait newAgentTransaction.save()\n\t\t\t\tconsole.log('saved new agent transaction')\n\t\t\t}\n\t\t}\n\n\t}catch(err){\n\t\tthrow err\n\t}\n\n}\n\nexport default saveNewHistoryBet"]}