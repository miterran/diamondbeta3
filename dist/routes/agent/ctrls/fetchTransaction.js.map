{"version":3,"sources":["../../../../src/routes/agent/ctrls/fetchTransaction.js"],"names":["fetchTransaction","req","res","weekNum","body","pendingTransactionList","newList","agentCredit","Number","user","currentStatus","credit","pendingCredit","find","_id","populate","path","select","openBets","sort","a","b","Date","createdAt","map","transaction","transactionIdx","wagerDetail","winAmount","orderNumber","orderType","owner","balance","$gte","subtract","startOf","$lte","endOf","transactionList","json"],"mappings":";;;;;;AAAA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;;;AAEA,IAAMA;AAAA,sDAAmB,iBAAOC,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAChBC,aADgB,GACJF,IAAIG,IADA,CAChBD,OADgB;AAGpBE,4BAHoB,GAGK,EAHL;AAIpBC,aAJoB,GAIV,EAJU;;AAAA,YAMpBH,YAAY,CANQ;AAAA;AAAA;AAAA;;AAOnBI,iBAPmB,GAOLC,OAAOP,IAAIQ,IAAJ,CAASC,aAAT,CAAuBC,MAA9B,CAPK;AAQnBC,mBARmB,GAQH,CARG;AAAA;AAAA,aASF,kBAAQC,IAAR,CAAa;AACjC,sBAAeZ,IAAIQ,IAAJ,CAASK;AADS,OAAb,EAElB,0DAFkB,EAGpBC,QAHoB,CAGX,EAAEC,MAAM,cAAR,EAAwBC,QAAQ,kBAAhC,EAHW,CATE;;AAAA;AASnBC,cATmB;;AAavBA,eAASC,IAAT,CAAc,UAACC,CAAD,EAAIC,CAAJ,EAAU;AAAE,cAAO,IAAIC,IAAJ,CAASF,EAAEG,SAAX,IAAwB,IAAID,IAAJ,CAASD,EAAEE,SAAX,CAA/B;AAAsD,OAAhF;AACAlB,+BAAyBa,SAASM,GAAT,CAAa,UAACC,WAAD,EAAcC,cAAd,EAAgC;AACrEnB,sBAAeC,OAAOiB,YAAYE,WAAZ,CAAwBC,SAA/B,CAAf;AACA,cAAO;AACNC,qBAAaJ,YAAYI,WADnB;AAENC,mBAAWL,YAAYK,SAFjB;AAGNP,mBAAWE,YAAYF,SAHjB;AAINI,qBAAaF,YAAYE,WAJnB;AAKNI,eAAON,YAAYM,KALb;AAMNC,iBAASzB;AANH,QAAP;AAQA,OAVwB,CAAzB;;AAduB;AAAA;AAAA,aA2BM,2BAAiBM,IAAjB,CAAsB;AACnD,sBAAeZ,IAAIQ,IAAJ,CAASK,GAD2B;AAEnDS,kBAAW,EAAEU,MAAM,wBAASC,QAAT,CAAkB/B,OAAlB,EAA2B,GAA3B,EAAgCgC,OAAhC,CAAwC,SAAxC,CAAR,EAA4DC,MAAM,wBAASF,QAAT,CAAkB/B,OAAlB,EAA2B,GAA3B,EAAgCkC,KAAhC,CAAsC,SAAtC,CAAlE;AAFwC,OAAtB,EAG3BtB,QAH2B,CAGlB,EAAEC,MAAM,aAAR,EAAuBC,QAAQ,kBAA/B,EAHkB,EAGkCF,QAHlC,CAG2C,EAAEC,MAAM,cAAR,EAAwBC,QAAQ,kBAAhC,EAH3C,CA3BN;;AAAA;AA2BlBqB,qBA3BkB;;;AAgCxBpC,UAAIqC,IAAJ,CAAS,EAAED,iBAAiBA,eAAnB,EAAoCjC,wBAAwBA,sBAA5D,EAAT;;AAhCwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAAnB;;AAAA;AAAA;AAAA;AAAA,GAAN;;kBAmCeL,gB;;AAMf","file":"fetchTransaction.js","sourcesContent":["import moment from 'moment'\nimport Player from '../../../models/Player';\nimport Agent from '../../../models/Agent';\nimport AgentTransaction from '../../../models/AgentTransaction';\nimport { OpenBet } from '../../../models/BetOrder';\n\nconst fetchTransaction = async (req, res) => {\n\tconst { weekNum } = req.body\n\n\tlet pendingTransactionList = []\n\tlet newList = []\n\n\tif( weekNum === 0 ){\n\t\tlet agentCredit = Number(req.user.currentStatus.credit)\n\t\tlet pendingCredit = 0\n\t\tlet openBets = await OpenBet.find({ \n\t\t\t'owner.agent': req.user._id \n\t\t}, 'orderNumber orderType createdAt wagerDetail owner.player')\n\t\t.populate({ path: 'owner.player', select: 'account.username'})\n\t\topenBets.sort((a, b) => { return new Date(a.createdAt) - new Date(b.createdAt) })\n\t\tpendingTransactionList = openBets.map((transaction, transactionIdx)=> {\n\t\t\tagentCredit -= Number(transaction.wagerDetail.winAmount)\n\t\t\treturn {\n\t\t\t\torderNumber: transaction.orderNumber,\n\t\t\t\torderType: transaction.orderType,\n\t\t\t\tcreatedAt: transaction.createdAt,\n\t\t\t\twagerDetail: transaction.wagerDetail,\n\t\t\t\towner: transaction.owner,\n\t\t\t\tbalance: agentCredit\n\t\t\t}\n\t\t})\n\t}\n\n\tconst transactionList = await AgentTransaction.find({ \n\t\t'owner.agent': req.user._id, \n\t\tcreatedAt: { $gte: moment().subtract(weekNum, 'w').startOf('isoWeek'), $lte: moment().subtract(weekNum, 'w').endOf('isoWeek')}\n\t}).populate({ path: 'owner.agent', select: 'account.username'}).populate({ path: 'owner.player', select: 'account.username'})\n\n\tres.json({ transactionList: transactionList, pendingTransactionList: pendingTransactionList })\n}\n\nexport default fetchTransaction;\n\n\n\n\n\n// response.data.pendingTransactionList.sort((a, b) => { return new Date(b.createdAt) - new Date(a.createdAt) })"]}