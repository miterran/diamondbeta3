{"version":3,"sources":["../../../../src/routes/player/ctrls/submitSingleBetOrder.js"],"names":["submitSingleBetOrder","req","res","body","eventOdds","wagerDetails","orderType","findOne","_id","user","agent","totalWinAmount","Object","keys","map","Number","wager","winAmount","currentStatus","availableCredit","Promise","all","event","eventIdx","eventTimeOut","isSameOrAfter","cutOffTime","singlePickId","existed","isEmpty","status","betDetail","note","orderNumber","uniqueId","latestEvent","betDetailMatch","betDetailPrev","latestBetDetail","betType","betAmount","riskAmount","confirm","then","submitCheckPass","every","json","newOpenBet","process","toUpperCase","owner","player","superAgent","wagerDetail","save","console","log","catch","err"],"mappings":"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","file":"submitSingleBetOrder.js","sourcesContent":["import _ from 'lodash';\nimport uniqid from 'uniqid';\nimport moment from 'moment';\n\nimport Agent from '../../../models/Agent'\nimport Player from '../../../models/Player';\nimport { EventOdd } from '../../../models/EventOdd';\nimport { OpenBet, HistoryBet } from '../../../models/BetOrder';\n\nimport compareBetDetail from '../../../utils/compareBetDetail';\nimport updatePlayerStatusAfterOrder from '../../../updateDB/updateUser/updatePlayerStatusAfterOrder';\nimport updateAgentOpenBetStatusAfterOrder from '../../../updateDB/updateUser/updateAgentOpenBetStatusAfterOrder';\n//34976\nconst submitSingleBetOrder = async (req, res) => {\n\n\ttry{\n\n\t\tconst { eventOdds, wagerDetails, orderType } = req.body\n\n\t\tconst agent = await Agent.findOne({ _id: req.user.agent }, 'currentStatus.availableCredit')\n\n\t\tlet totalWinAmount = 0\n\t\tObject.keys(wagerDetails).map(wager => {\n\t\t\ttotalWinAmount += Number(wagerDetails[wager].winAmount)\n\t\t})\n\n\t\tif( agent.currentStatus.availableCredit > totalWinAmount ){\n\t\t\tawait Promise.all(eventOdds.map(async (event, eventIdx) => {\n\t\t\t\tconst eventTimeOut = moment().isSameOrAfter(moment(event.cutOffTime))\n\t\t\t\tconst existed = await OpenBet.findOne({ 'owner.player': req.user._id, orderType: orderType, 'eventOdds.singlePickId': event.singlePickId })\n\t\t\t\tswitch(true){\n\t\t\t\t\tcase eventTimeOut:\n\t\t\t\t\t\tevent.status = 'TimeOut'\n\t\t\t\t\t\tdelete event.betDetail\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase !_.isEmpty(existed):\n\t\t\t\t\t\tevent.status = 'Existed'\n\t\t\t\t\t\tevent.note = existed.orderNumber\n\t\t\t\t\t\tdelete event.betDetail\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconst latestEvent = await EventOdd.findOne({ uniqueId: event.uniqueId })\n\t\t\t\t\t\tif(compareBetDetail(event, latestEvent, orderType).betDetailMatch){\n\t\t\t\t\t\t\tevent.status = 'Pending'\n\t\t\t\t\t\t\tevent.note = ''\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tevent.status = 'HasUpdated'\n\t\t\t\t\t\t\tevent.betDetailPrev = event.betDetail\n\t\t\t\t\t\t\tevent.betDetail = compareBetDetail(event, latestEvent, orderType).latestBetDetail\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif(event.status !== 'Pending'){\n\t\t\t\t\twagerDetails[event.singlePickId] = {\n\t\t\t\t\t\tbetType: 'wager',\n\t\t\t\t\t\tbetAmount: 0,\n\t\t\t\t\t\triskAmount: 0,\n\t\t\t\t\t\twinAmount: 0,\n\t\t\t\t\t\tconfirm: false\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn event\n\t\t\t})).then(async () => {\n\t\t\t\tconst submitCheckPass = eventOdds.every(event => event.status === 'Pending')\n\t\t\t\tif(!submitCheckPass){\n\t\t\t\t\tres.json({ eventOdds: eventOdds, wagerDetails: wagerDetails })\n\t\t\t\t}else{\n\t\t\t\t\tawait Promise.all(eventOdds.map(async event => {\n\t\t\t\t\t\tconst newOpenBet = new OpenBet({\n\t\t\t\t\t\t\torderNumber: uniqid.process().toUpperCase(),\n\t\t\t\t\t\t\torderType: orderType,\n\t\t\t\t\t\t\towner:{\n\t\t\t\t\t\t\t\tplayer: req.user._id,\n\t\t\t\t\t\t\t\tagent: req.user.agent,\n\t\t\t\t\t\t\t\tsuperAgent: req.user.superAgent\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\twagerDetail: {\n\t\t\t\t\t\t\t\tbetType: wagerDetails[event.singlePickId].betType,\n\t\t\t\t\t\t\t\tbetAmount: wagerDetails[event.singlePickId].betAmount,\n\t\t\t\t\t\t\t\twinAmount: wagerDetails[event.singlePickId].winAmount,\n\t\t\t\t\t\t\t\triskAmount: wagerDetails[event.singlePickId].riskAmount\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tstatus: 'Pending',\n\t\t\t\t\t\t\teventOdds: [event]\n\t\t\t\t\t\t})\n\t\t\t\t\t\tawait newOpenBet.save().then(() => { console.log(`saved new openBet ${newOpenBet.orderNumber}`) }).catch(err => { throw err })\n\t\t\t\t\t\treturn null\n\t\t\t\t\t})).then(async () => {\n\t\t\t\t\t\tawait updatePlayerStatusAfterOrder(req.user._id)\n\t\t\t\t\t\tawait updateAgentOpenBetStatusAfterOrder(req.user.agent)\n\t\t\t\t\t\tres.json([])\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t}else{\n\t\t\tres.json('agentOutOfCredit')\n\t\t}\n\n\t}catch(err){\n\t\tthrow err\n\t}\n\n}\n\nexport default submitSingleBetOrder;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"]}