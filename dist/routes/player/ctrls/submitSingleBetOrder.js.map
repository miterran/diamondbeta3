{"version":3,"sources":["../../../../src/routes/player/ctrls/submitSingleBetOrder.js"],"names":["submitSingleBetOrder","req","res","body","eventOdds","wagerDetails","orderType","Promise","all","map","event","eventIdx","eventTimeOut","isSameOrAfter","cutOffTime","format","findOne","user","_id","singlePickId","existed","isEmpty","status","betDetail","note","orderNumber","uniqueId","latestEvent","betDetailMatch","betDetailPrev","latestBetDetail","betType","betAmount","riskAmount","winAmount","confirm","then","submitCheckPass","every","json","newOpenBet","process","toUpperCase","owner","player","agent","superAgent","wagerDetail","save","console","log","catch","err"],"mappings":"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","file":"submitSingleBetOrder.js","sourcesContent":["import _ from 'lodash';\nimport uniqid from 'uniqid';\nimport moment from 'moment';\nimport Player from '../../../models/Player';\nimport { EventOdd } from '../../../models/EventOdd';\nimport { OpenBet, HistoryBet } from '../../../models/BetOrder';\n\nimport compareBetDetail from '../../../utils/compareBetDetail';\nimport updatePlayerStatusAfterOrder from '../../../updateDB/updateUser/updatePlayerStatusAfterOrder';\nimport updateAgentOpenBetStatusAfterOrder from '../../../updateDB/updateUser/updateAgentOpenBetStatusAfterOrder';\n\nconst submitSingleBetOrder = async (req, res) => {\n\n\ttry{\n\n\t\tconst { eventOdds, wagerDetails, orderType } = req.body\n\t\tawait Promise.all(eventOdds.map(async (event, eventIdx) => {\n\t\t\tconst eventTimeOut = moment().isSameOrAfter(moment(event.cutOffTime).format())\n\t\t\tconst existed = await OpenBet.findOne({ 'owner.player': req.user._id, orderType: orderType, 'eventOdds.singlePickId': event.singlePickId })\n\t\t\tswitch(true){\n\t\t\t\tcase eventTimeOut:\n\t\t\t\t\tevent.status = 'TimeOut'\n\t\t\t\t\tdelete event.betDetail\n\t\t\t\t\tbreak;\n\t\t\t\tcase !_.isEmpty(existed):\n\t\t\t\t\tevent.status = 'Existed'\n\t\t\t\t\tevent.note = existed.orderNumber\n\t\t\t\t\tdelete event.betDetail\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tconst latestEvent = await EventOdd.findOne({ uniqueId: event.uniqueId })\n\t\t\t\t\tif(compareBetDetail(event, latestEvent, orderType).betDetailMatch){\n\t\t\t\t\t\tevent.status = 'Pending'\n\t\t\t\t\t\tevent.note = ''\n\t\t\t\t\t}else{\n\t\t\t\t\t\tevent.status = 'HasUpdated'\n\t\t\t\t\t\tevent.betDetailPrev = event.betDetail\n\t\t\t\t\t\tevent.betDetail = compareBetDetail(event, latestEvent, orderType).latestBetDetail\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(event.status !== 'Pending'){\n\t\t\t\twagerDetails[event.singlePickId] = {\n\t\t\t\t\tbetType: 'wager',\n\t\t\t\t\tbetAmount: 0,\n\t\t\t\t\triskAmount: 0,\n\t\t\t\t\twinAmount: 0,\n\t\t\t\t\tconfirm: false\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn event\n\t\t})).then(async () => {\n\t\t\tconst submitCheckPass = eventOdds.every(event => event.status === 'Pending')\n\t\t\tif(!submitCheckPass){\n\t\t\t\tres.json({ eventOdds: eventOdds, wagerDetails: wagerDetails })\n\t\t\t}else{\n\t\t\t\tawait Promise.all(eventOdds.map(async event => {\n\t\t\t\t\tconst newOpenBet = new OpenBet({\n\t\t\t\t\t\torderNumber: uniqid.process().toUpperCase(),\n\t\t\t\t\t\torderType: orderType,\n\t\t\t\t\t\towner:{\n\t\t\t\t\t\t\tplayer: req.user._id,\n\t\t\t\t\t\t\tagent: req.user.agent,\n\t\t\t\t\t\t\tsuperAgent: req.user.superAgent\n\t\t\t\t\t\t},\n\t\t\t\t\t\twagerDetail: {\n\t\t\t\t\t\t\tbetType: wagerDetails[event.singlePickId].betType,\n\t\t\t\t\t\t\tbetAmount: wagerDetails[event.singlePickId].betAmount,\n\t\t\t\t\t\t\twinAmount: wagerDetails[event.singlePickId].winAmount,\n\t\t\t\t\t\t\triskAmount: wagerDetails[event.singlePickId].riskAmount\n\t\t\t\t\t\t},\n\t\t\t\t\t\tstatus: 'Pending',\n\t\t\t\t\t\teventOdds: [event]\n\t\t\t\t\t})\n\t\t\t\t\tawait newOpenBet.save().then(() => { console.log(`saved new openBet ${newOpenBet.orderNumber}`) }).catch(err => { throw err })\n\t\t\t\t\treturn null\n\t\t\t\t})).then(async () => {\n\t\t\t\t\tawait updatePlayerStatusAfterOrder(req.user._id)\n\t\t\t\t\tawait updateAgentOpenBetStatusAfterOrder(req.user.agent)\n\t\t\t\t\tres.json([])\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\n\t}catch(err){\n\t\tthrow err\n\t}\n\n}\n\nexport default submitSingleBetOrder;\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"]}