{"version":3,"sources":["../../../../src/routes/player/ctrls/submitRadioBetOrder.js"],"names":["submitRadioBetOrder","req","res","body","eventOdds","wagerDetails","orderType","findOne","_id","user","agent","currentStatus","availableCredit","winAmount","newOrderCombo","map","event","find","existedOrders","existed","existedOrderNumber","existedOrderCombo","existedOrder","difference","length","orderNumber","Promise","all","eventTimeOut","isSameOrAfter","cutOffTime","format","status","betDetail","note","uniqueId","latestEvent","betDetailMatch","betDetailPrev","latestBetDetail","then","submitCheckPass","every","json","betType","betAmount","riskAmount","confirm","newOpenBet","process","toUpperCase","owner","player","superAgent","wagerDetail","save","console","log"],"mappings":"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","file":"submitRadioBetOrder.js","sourcesContent":["import _ from 'lodash';\nimport uniqid from 'uniqid';\nimport moment from 'moment';\nimport { EventOdd } from '../../../models/EventOdd';\nimport { OpenBet } from '../../../models/BetOrder';\n\nimport Agent from '../../../models/Agent'\n\nimport compareBetDetail from '../../../utils/compareBetDetail';\nimport updatePlayerStatusAfterOrder from '../../../updateDB/updateUser/updatePlayerStatusAfterOrder';\nimport updateAgentOpenBetStatusAfterOrder from '../../../updateDB/updateUser/updateAgentOpenBetStatusAfterOrder';\n\n\nconst submitRadioBetOrder = async (req, res) => {\n\n\ttry{\n\n\t\tconst { eventOdds, wagerDetails, orderType } = req.body \n\n\t\tconst agent = await Agent.findOne({ _id: req.user.agent }, 'currentStatus.availableCredit')\n\n\t\tif( agent.currentStatus.availableCredit > wagerDetails.winAmount ){\n\t\t\tconst newOrderCombo = eventOdds.map(event => { return event['singlePickId'] }) \n\t\t\tconst existedOrders = await OpenBet.find({ 'owner.player': req.user._id, 'orderType': orderType })\n\t\t\tlet existed = false\n\t\t\tlet existedOrderNumber = ''\n\n\t\t\texistedOrders.map(existedOrder => {\n\t\t\t\tif(existed) return\n\t\t\t\tconst existedOrderCombo = existedOrder.eventOdds.map(event => { return event['singlePickId'] }) \n\t\t\t\tif(_.difference(newOrderCombo, existedOrderCombo).length === 0){\n\t\t\t\t\texisted = true\n\t\t\t\t\texistedOrderNumber = existedOrder.orderNumber\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t})\n\n\t\t\tawait Promise.all(eventOdds.map(async event => {\n\t\t\t\tconst eventTimeOut = moment().isSameOrAfter(moment(event.cutOffTime).format())\n\t\t\t\tswitch(true){\n\t\t\t\t\tcase eventTimeOut:\n\t\t\t\t\t\tevent.status = 'TimeOut'\n\t\t\t\t\t\tdelete event.betDetail\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase existed:\n\t\t\t\t\t\tevent.status = 'Existed'\n\t\t\t\t\t\tevent.note = existedOrderNumber\n\t\t\t\t\t\tdelete event.betDetail\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconst latestEvent = await EventOdd.findOne({ uniqueId: event.uniqueId })\n\t\t\t\t\t\tif(compareBetDetail(event, latestEvent, orderType).betDetailMatch){\n\t\t\t\t\t\t\tevent.status = 'Pending'\n\t\t\t\t\t\t\tevent.note = ''\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tevent.status = 'HasUpdated'\n\t\t\t\t\t\t\tevent.betDetailPrev = event.betDetail\n\t\t\t\t\t\t\tevent.betDetail = compareBetDetail(event, latestEvent, orderType).latestBetDetail\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\treturn event\n\t\t\t})).then(async () => {\n\t\t\t\tconst submitCheckPass = eventOdds.every(event => event.status === 'Pending')\n\t\t\t\tif(!submitCheckPass){\n\t\t\t\t\tres.json({ eventOdds: eventOdds, wagerDetails: {\n\t\t\t\t\t\tbetType: 'risk',\n\t\t\t\t\t\tbetAmount: 0,\n\t\t\t\t\t\triskAmount: 0,\n\t\t\t\t\t\twinAmount: 0,\n\t\t\t\t\t\tconfirm: false\n\t\t\t\t\t}})\n\t\t\t\t}else{\n\t\t\t\t\tconst newOpenBet = new OpenBet({\n\t\t\t\t\t\torderNumber: uniqid.process().toUpperCase(),\n\t\t\t\t\t\torderType: orderType,\n\t\t\t\t\t\towner:{\n\t\t\t\t\t\t\tplayer: req.user._id,\n\t\t\t\t\t\t\tagent: req.user.agent,\n\t\t\t\t\t\t\tsuperAgent: req.user.superAgent\n\t\t\t\t\t\t},\n\t\t\t\t\t\twagerDetail: wagerDetails,\n\t\t\t\t\t\tstatus: 'Pending',\n\t\t\t\t\t\teventOdds: eventOdds\n\t\t\t\t\t})\n\t\t\t\t\tawait newOpenBet.save()\n\t\t\t\t\tconsole.log(`saved new openBet ${newOpenBet.orderNumber}`)\n\t\t\t\t\tawait updatePlayerStatusAfterOrder(req.user._id)\n\t\t\t\t\tawait updateAgentOpenBetStatusAfterOrder(req.user.agent)\n\t\t\t\t\tres.json([])\n\t\t\t\t}\n\t\t\t})\t\t\t\n\t\t}else{\n\t\t\tres.json('agentOutOfCredit')\n\t\t}\n\n\t}catch(err){\n\t\tthrow err\n\t}\n}\n\n\n\n\n\nexport default submitRadioBetOrder;\n\n"]}