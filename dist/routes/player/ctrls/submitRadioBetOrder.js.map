{"version":3,"sources":["../../../../src/routes/player/ctrls/submitRadioBetOrder.js"],"names":["submitRadioBetOrder","req","res","body","eventOdds","wagerDetails","orderType","newOrderCombo","map","event","find","user","_id","existedOrders","existed","existedOrderNumber","existedOrderCombo","existedOrder","difference","length","orderNumber","Promise","all","eventTimeOut","isSameOrAfter","cutOffTime","format","status","betDetail","note","findOne","eventOddId","latestEvent","betDetailPrev","latestBetDetail","then","submitCheckPass","every","json","betType","betAmount","riskAmount","winAmount","confirm","newOpenBet","process","toUpperCase","owner","player","agent","superAgent","wagerDetail","save","console","log","catch","err"],"mappings":"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","file":"submitRadioBetOrder.js","sourcesContent":["import _ from 'lodash';\nimport uniqid from 'uniqid';\nimport moment from 'moment';\nimport { EventOdd } from '../../../models/EventOdd';\nimport { OpenBet } from '../../../models/BetOrder';\n\nimport compareBetDetail from '../../../utils/compareBetDetail';\nimport updatePlayerStatusAfterOrder from '../../../updateDB/utils/updatePlayerStatusAfterOrder';\n\n\nconst submitRadioBetOrder = async (req, res) => {\n\tconst { eventOdds, wagerDetails, orderType } = req.body // make short name\n\n\tconst newOrderCombo = eventOdds.map(event => { return event['singlePickId'] }) // get new order id list, saved as an array\n\n\tconst existedOrders = await OpenBet.find({ 'owner.player': req.user._id, 'orderType': orderType }) // fetch combo existed openbet order\n\n\tlet existed = false\n\tlet existedOrderNumber = ''\n\n\texistedOrders.map(existedOrder => {\n\t\tif(existed) return\n\t\tconst existedOrderCombo = existedOrder.eventOdds.map(event => { return event['singlePickId'] }) // map each order and get order id list\n\t\tif(_.difference(newOrderCombo, existedOrderCombo).length === 0){ // compare new order and existed order id array.\n\t\t\texisted = true\n\t\t\texistedOrderNumber = existedOrder.orderNumber\n\t\t\treturn\n\t\t}\n\t})\n\n\tPromise.all(eventOdds.map(async event => {\n\t\tconst eventTimeOut = moment().isSameOrAfter(moment(event.cutOffTime).format())\n\t\tswitch(true){\n\t\t\tcase eventTimeOut:\n\t\t\t\tevent.status = 'TimeOut'\n\t\t\t\tdelete event.betDetail\n\t\t\t\tbreak;\n\t\t\tcase existed:\n\t\t\t\tevent.status = 'Existed'\n\t\t\t\tevent.note = existedOrderNumber\n\t\t\t\tdelete event.betDetail\n\t\t\t\tbreak;\n\t\t\tdefault:\n\n\t\t\t\tconst latestEvent = await EventOdd.findOne({ eventOddId: event.eventOddId })\n\t\t\t\tif(compareBetDetail(event, latestEvent)){\n\t\t\t\t\tevent.status = 'Pending'\n\t\t\t\t\tevent.note = ''\n\t\t\t\t}else{\n\t\t\t\t\tevent.status = 'HasUpdated'\n\t\t\t\t\tevent.betDetailPrev = event.betDetail\n\t\t\t\t\tevent.betDetail = latestBetDetail\n\t\t\t\t}\n\t\t\t\treturn\n\t\t}\n\t\treturn event\n\t})).then(async () => {\n\t\tconst submitCheckPass = eventOdds.every(event => event.status === 'Pending')\n\t\tif(!submitCheckPass){\n\t\t\tres.json({ eventOdds: eventOdds, wagerDetails: {\n\t\t\t\tbetType: 'risk',\n\t\t\t\tbetAmount: 0,\n\t\t\t\triskAmount: 0,\n\t\t\t\twinAmount: 0,\n\t\t\t\tconfirm: false\n\t\t\t}})\n\t\t}else{\n\t\t\tconst newOpenBet = new OpenBet({\n\t\t\t\torderNumber: uniqid.process().toUpperCase(),\n\t\t\t\torderType: orderType,\n\t\t\t\towner:{\n\t\t\t\t\tplayer: req.user._id,\n\t\t\t\t\tagent: req.user.agent,\n\t\t\t\t\tsuperAgent: req.user.superAgent\n\t\t\t\t},\n\t\t\t\twagerDetail: wagerDetails,\n\t\t\t\tstatus: 'Pending',\n\t\t\t\teventOdds: eventOdds\n\t\t\t})\n\t\t\tawait newOpenBet.save()\n\t\t\tconsole.log(`saved new openBet ${newOpenBet.orderNumber}`)\n\n\t\t\tawait updatePlayerStatusAfterOrder(req.user._id)\n\n\t\t\tres.json([])\n\t\t}\n\t}).catch(err => { throw err })\n\n}\n\n\n\n\n\nexport default submitRadioBetOrder;\n\n"]}